name: Claude Code Runner
on:
  issue_comment:
    types: [created]
  issues:
    types: [opened]

jobs:
  claude-runner:
    # mesoãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿å®Ÿè¡Œå¯èƒ½
    if: |
      github.event.issue.pull_request == null &&
      (github.event.issue.user.login == 'meso' || github.event.comment.user.login == 'meso') &&
      (
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'issues' && contains(github.event.issue.body, '@claude'))
      )
    runs-on: self-hosted
    permissions:
      issues: write
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Extract command and context
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            // @claude ã®å¾Œã®ã‚³ãƒãƒ³ãƒ‰ã‚’æŠ½å‡º
            let body, command;
            if (context.eventName === 'issue_comment') {
              body = context.payload.comment.body;
            } else {
              body = context.payload.issue.body;
            }
            
            const match = body.match(/@claude\s+(.+)/);
            command = match ? match[1].trim() : '';
            
            // issueã®å…¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number
            });
            
            // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ§‹ç¯‰
            const issueContext = {
              title: context.payload.issue.title,
              body: context.payload.issue.body,
              number: context.payload.issue.number,
              url: context.payload.issue.html_url,
              comments: comments.data.map(comment => ({
                author: comment.user.login,
                body: comment.body,
                created_at: comment.created_at
              }))
            };
            
            // ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿å­˜
            const fs = require('fs');
            const contextFile = '/tmp/issue-context.json';
            fs.writeFileSync(contextFile, JSON.stringify(issueContext, null, 2));
            
            // ã™ã¹ã¦ã®å¤‰æ•°ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆå¼•ç”¨ç¬¦å•é¡Œã‚’å®Œå…¨å›é¿ï¼‰
            const commandFile = '/tmp/claude-command.txt';
            const titleFile = '/tmp/issue-title.txt';
            const numberFile = '/tmp/issue-number.txt';
            
            fs.writeFileSync(commandFile, command);
            fs.writeFileSync(titleFile, context.payload.issue.title);
            fs.writeFileSync(numberFile, context.payload.issue.number.toString());
            
            // å‡ºåŠ›è¨­å®š
            core.setOutput('command_file', commandFile);
            core.setOutput('context_file', contextFile);
            core.setOutput('title_file', titleFile);
            core.setOutput('number_file', numberFile);
      
      - name: Post acknowledgment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ¤– Claude Codeå®Ÿè¡Œä¸­...'
            })
      
      - name: Run Claude Code
        id: claude
        env:
          COMMAND_FILE: ${{ steps.extract.outputs.command_file }}
          CONTEXT_FILE: ${{ steps.extract.outputs.context_file }}
          TITLE_FILE: ${{ steps.extract.outputs.title_file }}
          NUMBER_FILE: ${{ steps.extract.outputs.number_file }}
        run: |
          # ãƒ‡ãƒãƒƒã‚°: ç¾åœ¨ã®ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¡¨ç¤º
          echo "=== GENERATED SHELL SCRIPT ==="
          cat "$0"
          echo "=== END OF SCRIPT ==="
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã™ã¹ã¦ã®å€¤ã‚’èª­ã¿å–ã‚Š
          CLAUDE_COMMAND=$(cat "$COMMAND_FILE")
          ISSUE_TITLE=$(cat "$TITLE_FILE")
          ISSUE_NUMBER=$(cat "$NUMBER_FILE")
          
          echo "Issue #$ISSUE_NUMBER: $ISSUE_TITLE"
          echo "Executing: $CLAUDE_COMMAND"
          
          # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«çµæœã‚’ä¿å­˜
          OUTPUT_FILE=$(mktemp)
          
          # ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä»˜ãã§Claude Codeã‚’å®Ÿè¡Œï¼ˆå®Œå…¨ã«ãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ï¼‰
          printf 'GitHub Issue Context:\nTitle: ' > /tmp/claude-prompt.txt
          cat "$TITLE_FILE" >> /tmp/claude-prompt.txt
          printf '\nIssue Number: #' >> /tmp/claude-prompt.txt
          cat "$NUMBER_FILE" >> /tmp/claude-prompt.txt
          printf '\n\nFull Context (JSON):\n' >> /tmp/claude-prompt.txt
          cat "$CONTEXT_FILE" >> /tmp/claude-prompt.txt
          printf '\nUser Request: ' >> /tmp/claude-prompt.txt
          cat "$COMMAND_FILE" >> /tmp/claude-prompt.txt
          printf '\n\nPlease execute the user'\''s request with full understanding of the issue context above.\n' >> /tmp/claude-prompt.txt
          
          # Claude Codeã‚’å®Ÿè¡Œï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ï¼‰
          /usr/local/bin/claude --file /tmp/claude-prompt.txt > "$OUTPUT_FILE" 2>&1 || true
          
          # çµæœã‚’èª­ã¿è¾¼ã¿ï¼ˆGitHubã®åˆ¶é™ã‚’è€ƒæ…®ã—ã¦æœ€åˆã®1000è¡Œã®ã¿ï¼‰
          RESULT=$(head -n 1000 "$OUTPUT_FILE")
          
          # çµæœãŒé•·ã™ãã‚‹å ´åˆã¯è­¦å‘Šã‚’è¿½åŠ 
          if [ $(wc -l < "$OUTPUT_FILE") -gt 1000 ]; then
            RESULT="${RESULT}
...
(å‡ºåŠ›ãŒé•·ã™ãã‚‹ãŸã‚ã€æœ€åˆã®1000è¡Œã®ã¿è¡¨ç¤º)"
          fi
          
          # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
          rm -f "$OUTPUT_FILE"
          
          # GitHub Outputã«è¨­å®šï¼ˆæ”¹è¡Œã‚’é©åˆ‡ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼‰
          echo "result<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Post result
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… å®Ÿè¡Œçµæœ:\n```\n${{ steps.claude.outputs.result }}\n```'
            })