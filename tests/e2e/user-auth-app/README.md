# User Authentication E2E Tests

このディレクトリには、ユーザー認証を使用したE2Eテストが含まれています。APIキー認証では検証できないアクセスコントロール機能を包括的にテストします。

## テストスイート

### 1. `user-auth.test.ts`
- 基本的なCRUD操作（ユーザー認証）
- 複数ユーザーでの同時アクセス
- データ整合性の確認
- ユーザーコンテキストの維持

### 2. `access-control.test.ts`
- テーブルアクセスポリシー（public/private）
- owner_idベースのデータフィルタリング
- ユーザー権限検証
- データ分離テスト

### 3. `push-notifications-user.test.ts`
- ユーザー認証でのPush通知サブスクリプション
- ユーザー固有の通知配信
- 通知ルール管理（ユーザーコンテキスト）
- Push通知のアクセス制御

### 4. `realtime-user.test.ts`
- ユーザー認証でのリアルタイム機能
- ユーザー固有のイベントフィルタリング
- マルチユーザーでのリアルタイムコラボレーション
- リアルタイムアクセス制御

## 実行方法

```bash
# 全てのユーザー認証E2Eテストを実行
pnpm test

# 特定のテストスイートを実行
pnpm test:access-control    # アクセスコントロールテスト
pnpm test:user-auth        # ユーザー認証テスト
pnpm test:push-user        # Push通知ユーザーテスト
pnpm test:realtime-user    # リアルタイムユーザーテスト
```

## 前提条件

### 必要な環境変数
```bash
VIBEBASE_API_URL=http://localhost:8787
VIBEBASE_API_KEY=vb_live_test123456789012345678901234567890
```

### 必要なユーザーデータ
テストユーザーが事前にデータベースに存在している必要があります：
- alice@example.com
- bob@example.com
- charlie@example.com（一部のテストで使用）

### VAPIDキー
Push通知テストには、VAPIDキーが初期化されている必要があります。

## 現在の制限事項

### ユーザートークンの取得
現在、実際のユーザー認証トークンを取得する機能が未実装のため、モックトークンを使用しています：
```typescript
const aliceToken = `mock-user-token-${testUsers[0].id}`;
```

実装時は、以下のような認証フローに置き換える必要があります：
```typescript
// 将来の実装例
const aliceToken = await authClient.authenticate('alice@example.com', 'password');
```

### テーブルポリシー設定
一部のテストでは、テーブルのアクセスポリシー（public/private）を動的に変更する機能が必要です。

## APIキーテストとの違い

| 機能 | APIキーテスト | ユーザー認証テスト |
|------|---------------|-------------------|
| データアクセス | 管理者権限で全データアクセス | owner_idでフィルタリング |
| アクセス制御 | テストできない | 完全にテスト可能 |
| Push通知サブスクリプション | 不可 | 可能 |
| ユーザー固有機能 | 制限あり | フル機能 |
| マルチユーザーシナリオ | 制限あり | 完全対応 |

## テスト対象機能

### ✅ アクセスコントロール
- テーブルレベルアクセスポリシー
- Row Level Security (owner_id filtering)
- ユーザー権限による操作制限
- データ分離と整合性

### ✅ ユーザー認証機能
- 複数ユーザーでの同時操作
- ユーザーコンテキスト維持
- セッション管理
- 認証エラーハンドリング

### ✅ Push通知（ユーザー認証）
- ユーザー固有のサブスクリプション管理
- ユーザー間の通知配信制御
- 通知ルールのユーザーコンテキスト
- 通知アクセス権限

### ✅ リアルタイム機能（ユーザー認証）
- ユーザー固有のイベントストリーム
- アクセス制御ベースのイベントフィルタリング
- マルチユーザーリアルタイムコラボレーション
- リアルタイム接続の認証

これらのテストにより、Vibebaseの重要なセキュリティ機能とユーザー体験が適切に動作することを保証します。